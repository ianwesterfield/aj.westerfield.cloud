```mermaid
flowchart TB
    subgraph User["Open-WebUI (8180)"]
        UserInput["User sends message"]
        UserReads["User reads response"]
    end

    subgraph Filter["AJ Filter (aj.filter.py)"]
        F1["1. Classify intent via Pragmatics"]
        F2["2. Route by intent"]
        F3["3. Inject context + results"]
    end

    subgraph Services["Service Layer"]
        direction TB
        Pragmatics["Pragmatics (8001)<br/>4-class DistilBERT<br/>casual/save/recall/task"]
        Memory["Memory API (8000)<br/>/save, /search"]
        
        subgraph OrchestratorBox["Orchestrator (8004)"]
            direction TB
            Reasoning["ReasoningEngine<br/>ğŸ§  Granite/Qwen"]
            BashDispatch["BashDispatcher<br/>âš™ï¸ All You Need is Bash"]
            Tools["6 Tools<br/>ğŸ–¥ï¸ bash, remote_bash<br/>ğŸ”„ remote_bash_all<br/>ğŸ“‹ list_agents<br/>ğŸ’­ think, complete"]
            
            Reasoning --> BashDispatch
            BashDispatch --> Tools
        end
        
        Extractor["Extractor (8002)<br/>LLaVA + Whisper<br/>Images/Audio/PDF"]
    end

    subgraph Remote["Remote Execution"]
        FunnelCloud["FunnelCloud Agents<br/>gRPC + mTLS<br/>Windows/Linux"]
    end

    subgraph Storage["Data Layer"]
        Qdrant["Qdrant (6333)<br/>768-dim COSINE<br/>all-mpnet-base-v2"]
        Ollama["Ollama (11434)<br/>LLM inference"]
        Workspace["Local Workspace<br/>bash subprocess"]
    end

    LLM["LLM Response"]

    %% User to Filter
    UserInput --> Filter

    %% Filter routes to services
    F1 --> Pragmatics
    Pragmatics -->|"intent"| F2

    %% Intent routing
    F2 -->|"casual"| LLM
    F2 -->|"save"| Memory
    F2 -->|"recall"| Memory
    F2 -->|"task"| OrchestratorBox

    %% Orchestrator flow
    Reasoning --> Ollama
    Tools -->|"bash"| Workspace
    Tools -->|"remote_bash"| FunnelCloud
    OrchestratorBox -->|"search patterns"| Memory

    %% Memory to Qdrant
    Memory -->|"embed/search"| Qdrant

    %% Results back to filter
    Memory -->|"context"| F3
    OrchestratorBox -->|"SSE stream<br/>thinking + results"| F3
    Extractor -->|"extracted text"| OrchestratorBox
    F3 --> LLM
    LLM --> UserReads
```
